<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NEXT STOP</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{
      --bg:#0b1220; --card: rgba(255,255,255,0.04); --glass: rgba(255,255,255,0.03);
      --text: #e6eef8; --muted: #9fb0c9; --accent: #60a5fa; --success:#34d399;
      --card-blur: 8px;
    }
    .light{--bg:#f6f9fc; --card: rgba(255,255,255,0.7); --glass: rgba(255,255,255,0.8); --text:#07203a; --muted:#5b6b78; --accent:#0ea5e9; --success:#059669;}

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--text);background:linear-gradient(180deg,var(--bg),#071029)}

    /* App layout */
    .app{display:grid;grid-template-columns:320px 1fr;gap:20px;height:100vh;padding:20px}

    /* Header */
    header.app-header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-radius:12px;background:var(--glass);backdrop-filter:blur(var(--card-blur));border:1px solid rgba(255,255,255,0.03)}
    .user{display:flex;align-items:center;gap:12px}
    .avatar{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:600}
    .username{font-weight:600}
    .header-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .icon-btn{background:transparent;border:none;padding:8px;border-radius:10px;cursor:pointer;color:var(--text)}

    /* Sidebar */
    .sidebar{background:var(--card);padding:16px;border-radius:12px;backdrop-filter:blur(var(--card-blur));border:1px solid rgba(255,255,255,0.03);overflow:auto;transition: transform 0.3s ease;}
    .search{display:flex;gap:10px;margin-bottom:12px}
    .search input{flex:1;padding:10px;border-radius:10px;border:none;background:rgba(0,0,0,0.15);color:var(--text)}
    .search .btn{padding:10px 12px;border-radius:10px;border:none;background:var(--accent);color:#022;cursor:pointer}

    .routes-list{display:flex;flex-direction:column;gap:8px}
    .route-card{padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));cursor:pointer;border:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center}
    .route-meta{font-size:13px;color:var(--muted)}
    .route-number{font-weight:700;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03)}

    /* Map + details */
    .main-panel{display:flex;flex-direction:column;gap:12px}
    .map-card{height:60vh;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(0,0,0,0.12),transparent)}
    #map{width:100%;height:100%}

    .details{padding:14px;border-radius:12px;background:var(--card);backdrop-filter:blur(var(--card-blur));border:1px solid rgba(255,255,255,0.03);overflow-y:auto;max-height:40vh}
    .details h3{margin:0 0 8px 0}
    .stops{display:flex;flex-direction:column;gap:6px}
    .stop{display:flex;gap:12px;align-items:flex-start}
    .stop .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);margin-top:6px}
    .stop small{color:var(--muted)}

    /* Timeline look */
    .timeline{border-left:2px dashed rgba(255,255,255,0.03);padding-left:12px;margin-left:6px}

    /* Footer small */
    .footer-note{font-size:13px;color:var(--muted);margin-top:8px}

    /* Responsive */
    @media (max-width: 980px){
      .app{grid-template-columns:1fr;grid-auto-rows:auto;padding:12px}
      .map-card{height:50vh}
      .sidebar{position:absolute;top:60px;left:0;width:280px;height:calc(100% - 60px);transform:translateX(-100%);z-index:999}
      .sidebar.active{transform:translateX(0);}
      .hamburger{display:inline-flex}
    }
    @media (max-width: 600px){
      header.app-header{padding:10px}
      .app{padding:8px}
      .map-card{height:42vh}
      .route-card{font-size:14px}
      .details h3{font-size:16px}
      .search input{padding:8px;font-size:14px}
      .details{max-height:35vh}
    }

    /* Active route highlight */
    .route-card.active{box-shadow:0 8px 30px rgba(0,0,0,0.5);transform:translateY(-2px);border-color:rgba(96,165,250,0.12)}

    /* light mode tweaks for inputs and cards */
    .light .search input{background:rgba(255,255,255,0.9);color:var(--text)}
    .light .route-card{background:rgba(255,255,255,0.8);border-color:rgba(0,0,0,0.04)}
    .light .details{background:rgba(255,255,255,0.9);}
  </style>
</head>
<body>

  <div class="app" id="app">

    <!-- Header -->
    <header class="app-header">
      <div class="user">
        <div class="avatar">AK</div>
        <div>
          <div class="username">sk akib</div>
          <div style="font-size:12px;color:var(--muted)">Welcome back</div>
        </div>
      </div>

      <div class="header-actions">
        <button class="icon-btn hamburger" id="hamburger" title="Toggle routes">‚ò∞</button>
        <button class="icon-btn" id="locateBtn" title="Find nearby stops">üìç</button>
        <button class="icon-btn" id="downloadBtn" title="Download current route JSON">‚¨áÔ∏è</button>
        <button class="icon-btn" id="themeBtn" title="Toggle theme">üåì</button>
      </div>
    </header>

    <!-- Sidebar: routes + search -->
    <aside class="sidebar" id="sidebar">
      <div class="search">
        <input id="searchInput" placeholder="Search route, stop or pincode" />
        <button class="btn" id="searchBtn">Search</button>
      </div>

      <div class="routes-list" id="routesList">
        <!-- routes inserted here -->
      </div>

      <div class="footer-note">Tip: tap a route to view on map ‚Äî markers are clickable</div>
    </aside>

    <!-- Main panel: map + details -->
    <section class="main-panel">
      <div class="map-card">
        <div id="map"></div>
      </div>

      <div class="details" id="details">
        <h3>No route selected</h3>
        <p class="footer-note">Select a route from the left to view stops, timetable and download data.</p>
      </div>
    </section>

  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Routes data: Kolkata + demo routes
    const routes = [
      { 
        id:'kolkata1',
        number: '215A',
        name: 'Dunlop ‚Üí Shyambazar',
        color:'#e11d48',
        first:'05:30',
        last:'22:00',
        freq:'10‚Äì15 mins',
        stops:[
          {name:'Dunlop', lat:22.6519, lng:88.3768, p:700108},
          {name:'Sinthi More', lat:22.6289, lng:88.3742, p:700050},
          {name:'Chiria More', lat:22.6247, lng:88.3737, p:700037},
          {name:'Rabindra Bharati', lat:22.6219, lng:88.3734, p:700050},
          {name:'Chitpur', lat:22.6186, lng:88.3731, p:700002},
          {name:'Cossipore', lat:22.6163, lng:88.3730, p:700002},
          {name:'Bagbazar', lat:22.6074, lng:88.3725, p:700003},
          {name:'Sovabazar', lat:22.6033, lng:88.3725, p:700005},
          {name:'Shyambazar', lat:22.6013, lng:88.3726, p:700004}
        ]
      },
    ];

    // Map init
    const map = L.map('map', {zoomControl:false}).setView([22.62,88.373],13);
    const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'¬©OpenStreetMap, ¬©CARTO'});
    const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬©OpenStreetMap'});
    darkTiles.addTo(map);

    const routeLayer = L.layerGroup().addTo(map);

    // UI elements
    const routesListEl = document.getElementById('routesList');
    const detailsEl = document.getElementById('details');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const themeBtn = document.getElementById('themeBtn');
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.getElementById('sidebar');
    const locateBtn = document.getElementById('locateBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    let activeRoute = null;

    function renderRoutes(list=routes){
      routesListEl.innerHTML = '';
      list.forEach(r=>{
        const el = document.createElement('div');
        el.className = 'route-card';
        el.innerHTML = `<div><div style="display:flex;gap:8px;align-items:center"><div class="route-number">${r.number}</div><div style='font-weight:600'>${r.name}</div></div><div class='route-meta'>${r.first} ¬∑ ${r.last} ¬∑ ${r.freq}</div></div>`;
        el.onclick = ()=>{ selectRoute(r, el) };
        routesListEl.appendChild(el);
      });
    }

    function selectRoute(route, el){
      document.querySelectorAll('.route-card').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      activeRoute = route;

      routeLayer.clearLayers();
      const latlngs = route.stops.map(s=>[s.lat,s.lng]);
      L.polyline(latlngs,{color:route.color,weight:5,opacity:0.9}).addTo(routeLayer);
      route.stops.forEach((s,i)=>{
        L.circleMarker([s.lat,s.lng],{radius:7,fill:true,fillColor:route.color,color:'#fff',weight:1}).addTo(routeLayer)
          .bindPopup(`<strong>${s.name}</strong><div style='font-size:12px;color:${getComputedStyle(document.documentElement).getPropertyValue('--muted')};'>PIN: ${s.p}</div>`);
      });
      map.fitBounds(L.polyline(latlngs).getBounds().pad(0.2));

      detailsEl.innerHTML = `
        <h3>${route.number} ‚Äî ${route.name}</h3>
        <div class="route-meta">First: ${route.first} ¬∑ Last: ${route.last} ¬∑ Frequency: ${route.freq}</div>
        <div style="height:12px"></div>
        <div class="timeline">
          <div class="stops">
            ${route.stops.map((s,i)=>`<div class="stop"><div class="dot"></div><div><strong>${s.name}</strong><br><small>Lat ${s.lat.toFixed(5)}, Lng ${s.lng.toFixed(5)} ¬∑ PIN ${s.p}</small></div></div>`).join('')}
          </div>
        </div>
      `;
    }

    // search
    function doSearch(){
      const q = searchInput.value.trim().toLowerCase();
      if(!q){ renderRoutes(); return }
      const filtered = routes.filter(r=> r.number.toLowerCase().includes(q) || r.name.toLowerCase().includes(q) || r.stops.some(s=>s.name.toLowerCase().includes(q) || String(s.p).includes(q)) );
      renderRoutes(filtered);
    }
    searchBtn.onclick = doSearch;
    searchInput.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch() });

    // theme
    themeBtn.onclick = ()=>{
      document.body.classList.toggle('light');
      if(document.body.classList.contains('light')){ map.removeLayer(darkTiles); lightTiles.addTo(map); } 
      else { map.removeLayer(lightTiles); darkTiles.addTo(map); }
    }

    // hamburger toggle
    hamburger.onclick = ()=>{
      sidebar.classList.toggle('active');
      setTimeout(()=>map.invalidateSize(), 300); // redraw map
    }
    window.addEventListener('resize', ()=>{ if(window.innerWidth>980){ sidebar.classList.remove('active'); map.invalidateSize() } });

    // locate nearby
    locateBtn.onclick = ()=>{
      if(!navigator.geolocation){ alert('Geolocation not supported') ; return }
      locateBtn.disabled = true; locateBtn.innerText = 'Locating...';
      navigator.geolocation.getCurrentPosition(pos=>{
        locateBtn.disabled=false; locateBtn.innerText='üìç';
        const {latitude,longitude} = pos.coords;
        L.circleMarker([latitude,longitude],{radius:8,color:'#fff',fillColor: 'orange',fillOpacity:1}).addTo(routeLayer).bindPopup('You are here').openPopup();
        let nearest = null; let bestDist = Infinity; let bestRoute=null;
        routes.forEach(r=> r.stops.forEach(s=>{
          const d = distance(latitude,longitude,s.lat,s.lng);
          if(d<bestDist){ bestDist=d; nearest=s; bestRoute=r }
        }));
        if(nearest){ map.setView([nearest.lat,nearest.lng],15); alert(`Nearest stop: ${nearest.name} (Route ${bestRoute.number}) ‚Äî ${(bestDist/1000).toFixed(2)} km`) }
      }, err=>{ locateBtn.disabled=false; locateBtn.innerText='üìç'; alert('Could not get location') })
    }

    // download JSON
    downloadBtn.onclick = ()=>{
      if(!activeRoute){ alert('Select a route first'); return }
      const blob = new Blob([JSON.stringify(activeRoute, null, 2)],{type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=`${activeRoute.number}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function distance(lat1,lon1,lat2,lon2){
      function toRad(v){return v*Math.PI/180}
      const R=6371000; const dLat=toRad(lat2-lat1); const dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
      const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c;
    }

    // init
    renderRoutes();
    setTimeout(()=>{
      const firstRoute = Array.from(document.querySelectorAll('.route-card')).find(r=>r.innerText.includes('215A'));
      if(firstRoute) firstRoute.click();
    },400);
  </script>

</body>
</html>
